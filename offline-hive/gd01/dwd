use gmall_work_01;

-- 1. 商品访问事实表
CREATE TABLE dwd_item_visit_di (
                                   visit_id BIGINT PRIMARY KEY COMMENT '访问ID',
                                   user_id BIGINT NOT NULL COMMENT '用户ID',
                                   item_id BIGINT NOT NULL COMMENT '商品ID',
                                   date_key INT NOT NULL COMMENT '日期键',
                                   visit_time DATETIME NOT NULL COMMENT '访问时间',
                                   dwell_seconds INT COMMENT '停留时长(秒)',
                                   terminal_code VARCHAR(20) COMMENT '终端代码',
                                   device_type ENUM('PC','Mobile','Tablet') COMMENT '设备类型',
                                   category_id INT COMMENT '类目ID',
                                   price DECIMAL(10,2) COMMENT '商品价格',
                                   etl_time DATETIME NOT NULL COMMENT 'ETL时间',
                                   KEY idx_date (date_key),
                                   KEY idx_item (item_id),
                                   KEY idx_user (user_id)
) COMMENT 'DWD-商品访问事实表';

-- 2. 支付事实表
CREATE TABLE dwd_payment_di (
                                payment_id BIGINT PRIMARY KEY COMMENT '支付ID',
                                order_id BIGINT NOT NULL COMMENT '订单ID',
                                item_id BIGINT NOT NULL COMMENT '商品ID',
                                user_id BIGINT NOT NULL COMMENT '用户ID',
                                date_key INT NOT NULL COMMENT '日期键',
                                payment_time DATETIME NOT NULL COMMENT '支付时间',
                                payment_amount DECIMAL(12,2) NOT NULL COMMENT '支付金额',
                                method_id VARCHAR(20) COMMENT '支付方式ID',
                                method_name VARCHAR(100) COMMENT '支付方式名称',
                                activity_id VARCHAR(20) COMMENT '活动ID',
                                activity_name VARCHAR(100) COMMENT '活动名称',
                                category_id INT COMMENT '类目ID',
                                etl_time DATETIME NOT NULL COMMENT 'ETL时间',
                                KEY idx_date (date_key),
                                KEY idx_item (item_id),
                                KEY idx_user (user_id)
) COMMENT 'DWD-支付事实表';

-- 3. 下单事实表
CREATE TABLE dwd_order_di (
                              order_id BIGINT NOT NULL COMMENT '订单ID',
                              item_id BIGINT NOT NULL COMMENT '商品ID',
                              user_id BIGINT NOT NULL COMMENT '用户ID',
                              date_key INT NOT NULL COMMENT '日期键',
                              order_time DATETIME NOT NULL COMMENT '下单时间',
                              quantity INT NOT NULL COMMENT '件数',
                              order_amount DECIMAL(12,2) NOT NULL COMMENT '订单金额',
                              order_status VARCHAR(20) NOT NULL COMMENT '订单状态',
                              category_id INT COMMENT '类目ID',
                              price DECIMAL(10,2) COMMENT '商品价格',
                              etl_time DATETIME NOT NULL COMMENT 'ETL时间',
                              PRIMARY KEY (order_id, item_id),
                              KEY idx_date (date_key),
                              KEY idx_item (item_id),
                              KEY idx_user (user_id)
) COMMENT 'DWD-下单事实表';

-- 4. 商品收藏事实表
CREATE TABLE dwd_item_fav_di (
                                 fav_id BIGINT PRIMARY KEY COMMENT '收藏ID',
                                 user_id BIGINT NOT NULL COMMENT '用户ID',
                                 item_id BIGINT NOT NULL COMMENT '商品ID',
                                 date_key INT NOT NULL COMMENT '日期键',
                                 fav_time DATETIME NOT NULL COMMENT '收藏时间',
                                 action_type ENUM('ADD','REMOVE') NOT NULL COMMENT '动作类型',
                                 category_id INT COMMENT '类目ID',
                                 etl_time DATETIME NOT NULL COMMENT 'ETL时间',
                                 KEY idx_date (date_key),
                                 KEY idx_item (item_id),
                                 KEY idx_user (user_id)
) COMMENT 'DWD-商品收藏事实表';

-- 5. 购物车操作事实表
CREATE TABLE dwd_cart_action_di (
                                    cart_id BIGINT PRIMARY KEY COMMENT '操作ID',
                                    user_id BIGINT NOT NULL COMMENT '用户ID',
                                    item_id BIGINT NOT NULL COMMENT '商品ID',
                                    date_key INT NOT NULL COMMENT '日期键',
                                    cart_time DATETIME NOT NULL COMMENT '操作时间',
                                    quantity INT NOT NULL COMMENT '件数',
                                    action_type ENUM('ADD','REMOVE') NOT NULL COMMENT '动作类型',
                                    category_id INT COMMENT '类目ID',
                                    price DECIMAL(10,2) COMMENT '商品价格',
                                    etl_time DATETIME NOT NULL COMMENT 'ETL时间',
                                    KEY idx_date (date_key),
                                    KEY idx_item (item_id),
                                    KEY idx_user (user_id)
) COMMENT 'DWD-购物车操作事实表';

-- 6. 商品微详情浏览事实表
CREATE TABLE dwd_item_micro_detail_di (
                                          micro_id BIGINT PRIMARY KEY COMMENT '浏览ID',
                                          user_id BIGINT NOT NULL COMMENT '用户ID',
                                          item_id BIGINT NOT NULL COMMENT '商品ID',
                                          date_key INT NOT NULL COMMENT '日期键',
                                          start_time DATETIME NOT NULL COMMENT '开始时间',
                                          duration_sec INT NOT NULL COMMENT '浏览时长(秒)',
                                          terminal_code VARCHAR(20) COMMENT '终端代码',
                                          device_type ENUM('PC','Mobile','Tablet') COMMENT '设备类型',
                                          category_id INT COMMENT '类目ID',
                                          etl_time DATETIME NOT NULL COMMENT 'ETL时间',
                                          KEY idx_date (date_key),
                                          KEY idx_item (item_id),
                                          KEY idx_user (user_id)
) COMMENT 'DWD-商品微详情浏览事实表';



-- 1. 商品访问事实表
INSERT INTO dwd_item_visit_di
SELECT
    v.visit_id,
    v.user_id,
    v.item_id,
    v.date_key,
    v.visit_time,
    v.dwell_seconds,
    v.terminal AS terminal_code,
    t.device_type,
    i.category_id,
    i.price,
    NOW()
FROM ods_event_item_visit v
         JOIN dim_item i ON v.item_id = i.item_id
         JOIN dim_terminal t ON v.terminal = t.terminal_code;

-- 2. 支付事实表
INSERT INTO dwd_payment_di
           SELECT
               p.payment_id,
               p.order_id,
               p.item_id,
               p.user_id,
               p.date_key,
               p.payment_time,
               p.payment_amount,
               p.payment_method AS method_id,
               m.method_name,
               a.activity_id,
               a.activity_name,
               i.category_id,
               NOW()
           FROM ods_event_payment p
                    JOIN dim_payment_method m ON p.payment_method = m.method_id
                    JOIN dim_item i ON p.item_id = i.item_id
                    LEFT JOIN dim_activity a ON
               -- 关键修改：将CASE结果的排序规则指定为与activity_id一致的utf8mb4_general_ci
               (CASE
                   WHEN p.is_juhuasuan = 1 THEN 'JUHUASUAN'
                   WHEN p.is_presale = 1 THEN CONCAT('PRESALE-', p.presale_stage)
                   ELSE 'NORMAL'
               END) COLLATE utf8mb4_general_ci = a.activity_id;

-- 3. 下单事实表
INSERT INTO dwd_order_di
SELECT
    o.order_id,
    o.item_id,
    o.user_id,
    o.date_key,
    o.order_time,
    o.quantity,
    o.order_amount,
    o.order_status,
    i.category_id,
    i.price,
    NOW()
FROM ods_event_order o
         JOIN dim_item i ON o.item_id = i.item_id;

-- 4. 商品收藏事实表
INSERT INTO dwd_item_fav_di
SELECT
    f.fav_id,
    f.user_id,
    f.item_id,
    f.date_key,
    f.fav_time,
    f.action_type,
    i.category_id,
    NOW()
FROM ods_event_item_favorite f
         JOIN dim_item i ON f.item_id = i.item_id;

-- 5. 购物车操作事实表
INSERT INTO dwd_cart_action_di
SELECT
    c.cart_id,
    c.user_id,
    c.item_id,
    c.date_key,
    c.cart_time,
    c.quantity,
    c.action_type,
    i.category_id,
    i.price,
    NOW()
FROM ods_event_item_cart c
         JOIN dim_item i ON c.item_id = i.item_id;

-- 6. 商品微详情浏览事实表
INSERT INTO dwd_item_micro_detail_di
SELECT
    m.micro_id,
    m.user_id,
    m.item_id,
    m.date_key,
    m.start_time,
    m.duration_sec,
    m.terminal AS terminal_code,
    t.device_type,
    i.category_id,
    NOW()
FROM ods_event_item_micro_detail m
         JOIN dim_item i ON m.item_id = i.item_id
         JOIN dim_terminal t ON m.terminal = t.terminal_code;